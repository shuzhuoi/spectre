<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dify API æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 12px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            font-family: monospace;
        }
        button {
            background: #409eff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background: #66b1ff;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            background: #f0f9ff;
            border: 1px solid #b3d8ff;
        }
        .error {
            background: #fef0f0;
            border-color: #fbc4c4;
            color: #f56c6c;
        }
        .success {
            background: #f0f9ff;
            border-color: #b3d8ff;
            color: #409eff;
        }
        .log {
            margin-top: 10px;
            padding: 10px;
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-item {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #3498db;
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Dify Workflow API æµ‹è¯•å·¥å…·</h1>
        
        <div class="config">
            <strong>å½“å‰é…ç½®ï¼š</strong><br>
            baseURL: http://192.168.210.85/v1<br>
            apiKey: app-gtrCLjE2A32SNXFoR05xVYfq<br>
            inputVariable: inputText<br>
            responseMode: streaming
        </div>

        <div class="input-group">
            <label>è¾“å…¥æ–‡æœ¬ï¼ˆå°†ä½œä¸º inputText å‚æ•°å‘é€ï¼‰ï¼š</label>
            <textarea id="inputText" placeholder=""></textarea>
        </div>

        <button onclick="testStreaming()">æµ‹è¯•æµå¼æ¨¡å¼</button>
        <button onclick="testBlocking()">æµ‹è¯•é˜»å¡æ¨¡å¼</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>

        <div id="result"></div>
        <div class="log" id="log"></div>
    </div>

    <script>
        const baseURL = 'http://192.168.210.85/v1';
        const apiKey = 'app-gtrCLjE2A32SNXFoR05xVYfq';
        const inputVariable = 'inputText';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.textContent = `[${time}] ${message}`;
            logDiv.appendChild(logItem);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showResult(message, isError = false) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = isError ? 'result error' : 'result success';
            resultDiv.innerHTML = `<strong>${isError ? 'âŒ é”™è¯¯' : 'âœ… æˆåŠŸ'}</strong><br>${message}`;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('result').innerHTML = '';
        }

        async function testStreaming() {
            const inputText = document.getElementById('inputText').value;
            
            log('å¼€å§‹æµ‹è¯•æµå¼æ¨¡å¼...');
            log(`è¾“å…¥æ–‡æœ¬: ${inputText}`);

            try {
                const response = await fetch(`${baseURL}/workflows/run`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inputs: {
                            [inputVariable]: inputText
                        },
                        response_mode: 'streaming',
                        user: 'test-user-' + Date.now()
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                log('âœ“ è¿æ¥æˆåŠŸï¼Œå¼€å§‹æ¥æ”¶æµå¼æ•°æ®...');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (!line.trim() || !line.startsWith('data: ')) continue;

                        try {
                            const jsonStr = line.substring(6).trim();
                            if (!jsonStr) continue;
                            
                            const event = JSON.parse(jsonStr);
                            
                            switch (event.event) {
                                case 'workflow_started':
                                    log('ğŸ“ Workflow å¼€å§‹æ‰§è¡Œ');
                                    break;
                                case 'node_started':
                                    log(`ğŸ”„ èŠ‚ç‚¹å¼€å§‹: ${event.data?.node_id}`);
                                    break;
                                case 'text_chunk':
                                    const text = event.data?.text || '';
                                    if (text) {
                                        fullText += text;
                                        log(`ğŸ“„ æ”¶åˆ°æ–‡æœ¬: ${text}`);
                                    }
                                    break;
                                case 'node_finished':
                                    log(`âœ“ èŠ‚ç‚¹å®Œæˆ: ${event.data?.node_id}`);
                                    break;
                                case 'workflow_finished':
                                    log(`âœ… Workflow å®Œæˆ: ${event.data?.status}`);
                                    break;
                                case 'ping':
                                    // å¿ƒè·³äº‹ä»¶ï¼Œä¸è®°å½•
                                    break;
                                default:
                                    log(`â„¹ï¸ å…¶ä»–äº‹ä»¶: ${event.event}`);
                            }
                        } catch (e) {
                            log(`âš ï¸ è§£æäº‹ä»¶å¤±è´¥: ${e.message}`);
                        }
                    }
                }

                showResult(`æµå¼æµ‹è¯•å®Œæˆï¼<br>æ¥æ”¶åˆ°çš„å®Œæ•´æ–‡æœ¬ï¼š<br><pre>${fullText || '(æ— æ–‡æœ¬è¾“å‡º)'}</pre>`);
                log('ğŸ‰ æµå¼æµ‹è¯•å®Œæˆ');

            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`);
                showResult(error.message, true);
            }
        }

        async function testBlocking() {
            const inputText = document.getElementById('inputText').value;
            
            log('å¼€å§‹æµ‹è¯•é˜»å¡æ¨¡å¼...');
            log(`è¾“å…¥æ–‡æœ¬: ${inputText}`);

            try {
                const response = await fetch(`${baseURL}/workflows/run`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inputs: {
                            [inputVariable]: inputText
                        },
                        response_mode: 'blocking',
                        user: 'test-user-' + Date.now()
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                log('âœ“ æ”¶åˆ°å“åº”');
                log(`å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}`);

                const outputText = result.data?.outputs?.text || 
                                 result.data?.outputs?.result || 
                                 '(æœªæ‰¾åˆ°è¾“å‡ºæ–‡æœ¬)';

                showResult(`é˜»å¡æµ‹è¯•å®Œæˆï¼<br>è¾“å‡ºæ–‡æœ¬ï¼š<br><pre>${outputText}</pre>`);
                log('ğŸ‰ é˜»å¡æµ‹è¯•å®Œæˆ');

            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`);
                showResult(error.message, true);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
        window.onload = function() {
            log('ğŸš€ Dify API æµ‹è¯•å·¥å…·å·²å°±ç»ª');
            log('è¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•');
        };
    </script>
</body>
</html>
